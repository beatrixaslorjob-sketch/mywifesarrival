<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Beatrix Countdown ‚úàÔ∏è</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Pacifico&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #ffdde1, #ee9ca7);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 15px;
      position: relative;
      overflow-x: hidden;
    }

    /* Particle canvas */
    #particles {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
    }

    .container {
      background: white;
      border-radius: 25px;
      padding: 30px 20px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      text-align: center;
      position: relative;
      z-index: 10;
    }

    /* Flight Map Styles */
    .flight-map-container {
      background: linear-gradient(135deg, #e0f2fe, #bae6fd);
      border-radius: 15px;
      padding: 15px;
      margin: 15px 0;
      border: 2px solid #0284c7;
      display: none;
    }

    .flight-map-container.active {
      display: block;
    }

    .flight-map-header {
      font-size: 14px;
      font-weight: 600;
      color: #0284c7;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    #flightMap {
      width: 100%;
      height: 250px;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .flight-info-box {
      background: white;
      border-radius: 10px;
      padding: 10px;
      margin-top: 12px;
      font-size: 12px;
      color: #666;
    }

    .flight-info-box strong {
      color: #0284c7;
    }

    .flight-stat {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .flight-stat:last-child {
      border-bottom: none;
    }

    h1 {
      color: #e75480;
      font-size: 26px;
      margin-bottom: 8px;
      font-family: 'Pacifico', cursive;
      font-weight: 400;
      line-height: 1.3;
    }

    .subtitle {
      color: #666;
      font-size: 14px;
      margin-bottom: 20px;
      line-height: 1.4;
    }

    .countdown {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin: 20px 0;
    }

    .time-box {
      background: linear-gradient(135deg, #fff0f3 0%, #ffe9ec 100%);
      border-radius: 15px;
      padding: 15px 8px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(231, 84, 128, 0.2);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .time-box::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transform: rotate(45deg);
      animation: shine 3s infinite;
    }

    @keyframes shine {
      0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
      100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
    }

    .time-box:active {
      transform: scale(0.95);
    }

    .time-box.urgent {
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
        box-shadow: 0 4px 15px rgba(231, 84, 128, 0.2);
      }
      50% {
        transform: scale(1.05);
        box-shadow: 0 8px 30px rgba(231, 84, 128, 0.5);
      }
    }

    .time-box.urgent .number {
      animation: numberPulse 2s ease-in-out infinite;
    }

    @keyframes numberPulse {
      0%, 100% {
        filter: drop-shadow(0 2px 4px rgba(231, 84, 128, 0.15));
      }
      50% {
        filter: drop-shadow(0 4px 12px rgba(231, 84, 128, 0.6));
      }
    }

    .number {
      font-size: 28px;
      font-weight: bold;
      background: linear-gradient(135deg, #e75480, #ff6b9d);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      display: block;
      position: relative;
      z-index: 1;
      text-shadow: 0 2px 10px rgba(231, 84, 128, 0.2);
      filter: drop-shadow(0 2px 4px rgba(231, 84, 128, 0.15));
    }

    .label {
      font-size: 10px;
      color: #999;
      text-transform: uppercase;
      margin-top: 4px;
      letter-spacing: 0.5px;
      font-weight: 600;
      position: relative;
      z-index: 1;
    }

    .info {
      background: #fff9e6;
      border-radius: 12px;
      padding: 12px;
      margin: 15px 0;
      font-size: 12px;
      color: #666;
      line-height: 1.6;
      text-align: left;
    }

    .info strong {
      display: inline-block;
      margin-right: 4px;
    }

    .flight-progress {
      background: linear-gradient(135deg, #fff0f3, #ffe9ec);
      border-radius: 12px;
      padding: 12px;
      margin: 15px 0;
      border: 2px solid #e75480;
    }

    .flight-progress-header {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      font-weight: 600;
      color: #e75480;
      margin-bottom: 10px;
      flex-wrap: wrap;
      gap: 5px;
    }

    .flight-progress-bar {
      position: relative;
      width: 100%;
      height: 18px;
      background: white;
      border-radius: 9px;
      overflow: visible;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }

    .flight-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #e75480, #ff6b9d);
      border-radius: 9px;
      transition: width 1s ease;
      box-shadow: 0 0 10px rgba(231,84,128,0.5);
    }

    .flight-progress-plane {
      position: absolute;
      top: -3px;
      left: 0;
      font-size: 22px;
      transition: left 1s ease;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
      animation: bobbing 2s ease-in-out infinite;
    }

    @keyframes bobbing {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-3px); }
    }

    .flight-progress-labels {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: #666;
      margin-top: 6px;
    }

    .flight-progress-labels span:nth-child(2) {
      color: #e75480;
      font-weight: 600;
    }

    .city-info-container {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin: 15px 0;
    }

    .city-info {
      background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
      border-radius: 12px;
      padding: 12px 8px;
      text-align: center;
    }

    .city-header {
      font-size: 12px;
      font-weight: 600;
      color: #0284c7;
      margin-bottom: 6px;
    }

    .city-time {
      font-size: 16px;
      font-weight: 700;
      color: #0369a1;
      margin-bottom: 4px;
    }

    .city-weather {
      font-size: 20px;
      margin: 6px 0;
    }

    .city-temp {
      font-size: 14px;
      color: #666;
      font-weight: 600;
    }

    .music-toggle {
      background: linear-gradient(135deg, #e75480, #ff6b9d);
      color: white;
      border: none;
      border-radius: 20px;
      padding: 12px 20px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(231, 84, 128, 0.3);
      margin-top: 15px;
      -webkit-appearance: none;
      touch-action: manipulation;
    }

    .music-toggle:active {
      transform: scale(0.95);
    }

    .music-toggle.active {
      background: linear-gradient(135deg, #10b981, #059669);
    }

    .temp-toggle {
      display: inline-flex;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 20px;
      padding: 4px;
      gap: 4px;
      margin-top: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .temp-toggle button {
      padding: 6px 14px;
      border: none;
      border-radius: 16px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      background: transparent;
      color: #999;
      -webkit-appearance: none;
      touch-action: manipulation;
    }

    .temp-toggle button.active {
      background: linear-gradient(135deg, #e75480, #ff6b9d);
      color: white;
      box-shadow: 0 2px 8px rgba(231, 84, 128, 0.3);
    }

    .temp-toggle button:active {
      transform: scale(0.95);
    }

    .message-section {
      background: linear-gradient(135deg, #fff5f7, #ffe9ec);
      border-radius: 15px;
      padding: 15px;
      margin: 15px 0;
      border: 2px solid #ffb3c1;
    }

    .message-header {
      font-size: 14px;
      font-weight: 600;
      color: #e75480;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .message-input {
      width: 100%;
      padding: 12px;
      border: 2px solid #ffb3c1;
      border-radius: 12px;
      font-family: 'Poppins', sans-serif;
      font-size: 14px;
      resize: vertical;
      min-height: 60px;
      transition: border-color 0.3s ease;
    }

    .message-input:focus {
      outline: none;
      border-color: #e75480;
      box-shadow: 0 0 0 3px rgba(231, 84, 128, 0.1);
    }

    .message-buttons {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .message-btn {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      -webkit-appearance: none;
      touch-action: manipulation;
    }

    .message-btn.save {
      background: linear-gradient(135deg, #e75480, #ff6b9d);
      color: white;
      box-shadow: 0 4px 15px rgba(231, 84, 128, 0.3);
    }

    .message-btn.clear {
      background: white;
      color: #999;
      border: 2px solid #e0e0e0;
    }

    .message-btn:active {
      transform: scale(0.95);
    }

    .message-display {
      background: white;
      border-radius: 12px;
      padding: 15px;
      margin-top: 10px;
      font-size: 14px;
      color: #666;
      line-height: 1.6;
      text-align: left;
      white-space: pre-wrap;
      word-wrap: break-word;
      display: none;
    }

    .message-display.active {
      display: block;
    }

    .message-display strong {
      color: #e75480;
    }

    .edit-message-btn {
      background: transparent;
      border: none;
      color: #e75480;
      font-size: 12px;
      cursor: pointer;
      text-decoration: underline;
      margin-top: 8px;
      padding: 0;
      font-weight: 600;
    }

    .progress-bar-container {
      background: #f0f0f0;
      border-radius: 15px;
      height: 7px;
      margin: 15px 0 8px 0;
      overflow: hidden;
      position: relative;
    }

    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #e75480, #ff6b9d);
      border-radius: 15px;
      transition: width 1s ease;
      box-shadow: 0 0 10px rgba(231,84,128,0.5);
    }

    .progress-text {
      font-size: 11px;
      color: #999;
      margin-top: 4px;
      font-weight: 600;
    }

    /* Mobile-specific optimizations */
    @media (max-width: 480px) {
      body {
        padding: 10px;
      }

      .container {
        padding: 25px 15px;
        border-radius: 20px;
      }

      h1 {
        font-size: 24px;
      }

      .subtitle {
        font-size: 13px;
      }

      .countdown {
        gap: 6px;
      }

      .time-box {
        padding: 12px 6px;
        border-radius: 12px;
      }

      .number {
        font-size: 24px;
      }

      .label {
        font-size: 9px;
        letter-spacing: 0.3px;
      }

      .info {
        font-size: 11px;
        padding: 10px;
      }

      .city-info-container {
        gap: 8px;
      }

      .city-info {
        padding: 10px 6px;
      }

      .city-header {
        font-size: 11px;
      }

      .city-time {
        font-size: 15px;
      }

      .city-weather {
        font-size: 18px;
      }

      .city-temp {
        font-size: 13px;
      }

      #flightMap {
        height: 200px;
      }

      .flight-map-header {
        font-size: 13px;
      }

      .flight-info-box {
        font-size: 11px;
        padding: 8px;
      }
    }

    /* Very small screens */
    @media (max-width: 360px) {
      h1 {
        font-size: 22px;
      }

      .number {
        font-size: 22px;
      }

      .label {
        font-size: 8px;
      }

      .info {
        font-size: 10px;
      }

      .city-time {
        font-size: 14px;
      }
    }

    /* Landscape mobile */
    @media (max-height: 600px) and (orientation: landscape) {
      body {
        padding: 10px;
      }

      .container {
        padding: 20px 15px;
        max-width: 90%;
      }

      h1 {
        font-size: 20px;
        margin-bottom: 5px;
      }

      .subtitle {
        font-size: 12px;
        margin-bottom: 12px;
      }

      .countdown {
        margin: 12px 0;
      }

      .time-box {
        padding: 10px 6px;
      }

      .number {
        font-size: 20px;
      }

      #particles {
        display: none;
      }
    }
  </style>
</head>
<body>
  <canvas id="particles"></canvas>
  
  <div class="container">
    <h1>Beatrix's Journey ‚úàÔ∏è</h1>
    <p class="subtitle" id="status">‚úàÔ∏è Until takeoff from JFK Terminal 8</p>
    
    <div class="countdown">
      <div class="time-box">
        <span class="number" id="days">00</span>
        <span class="label">Days</span>
      </div>
      <div class="time-box">
        <span class="number" id="hours">00</span>
        <span class="label">Hours</span>
      </div>
      <div class="time-box">
        <span class="number" id="minutes">00</span>
        <span class="label">Minutes</span>
      </div>
      <div class="time-box">
        <span class="number" id="seconds">00</span>
        <span class="label">Seconds</span>
      </div>
    </div>

    <div class="progress-bar-container">
      <div class="progress-bar-fill" id="percentFill"></div>
    </div>
    <div class="progress-text" id="percentText">0% of the wait complete</div>

    <div class="info">
      <strong>Flight Details:</strong> BA 114 ‚úàÔ∏è<br>
      <strong>Departure:</strong> Wednesday, March 4, 2026 at 10:15 AM (EST)<br>
      <strong>Arrival:</strong> Same day at 10:10 PM (GMT) London time<br>
      <strong>Flight Duration:</strong> <span style="color: #e75480; font-weight: bold;">7 hours 55 minutes</span>
    </div>

    <!-- Live Flight Map (shows during flight) -->
    <div class="flight-map-container" id="flightMapContainer">
      <div class="flight-map-header">
        <span>üõ©Ô∏è Live Flight Tracking</span>
      </div>
      <div id="flightMap"></div>
      <div class="flight-info-box">
        <div class="flight-stat">
          <span>Altitude:</span>
          <strong id="altitude">--</strong>
        </div>
        <div class="flight-stat">
          <span>Speed:</span>
          <strong id="speed">--</strong>
        </div>
        <div class="flight-stat">
          <span>Current Location:</span>
          <strong id="currentLocation">--</strong>
        </div>
      </div>
    </div>

    <div class="flight-progress" id="flightProgress" style="display: none;">
      <div class="flight-progress-header">
        <span>‚úàÔ∏è Flight in Progress</span>
        <span id="flightTimeRemaining">--h --m remaining</span>
      </div>
      <div class="flight-progress-bar">
        <div class="flight-progress-fill" id="flightProgressFill"></div>
        <div class="flight-progress-plane">‚úàÔ∏è</div>
      </div>
      <div class="flight-progress-labels">
        <span>üá∫üá∏ JFK</span>
        <span id="flightProgressPercent">0%</span>
        <span>üá¨üáß LHR</span>
      </div>
    </div>

    <div class="city-info-container">
      <div class="city-info">
        <div class="city-header">üóΩ New York</div>
        <div class="city-time" id="nyTime">--:--</div>
        <div class="city-weather" id="nyWeatherIcon">üå§Ô∏è</div>
        <div class="city-temp" id="nyTemp">--¬∞F</div>
      </div>
      <div class="city-info">
        <div class="city-header">üá¨üáß London</div>
        <div class="city-time" id="lonTime">--:--</div>
        <div class="city-weather" id="lonWeatherIcon">üå§Ô∏è</div>
        <div class="city-temp" id="lonTemp">--¬∞C</div>
      </div>
    </div>

    <div class="message-section">
      <div class="message-header">üíå Leave a Message</div>
      <div id="messageInputSection">
        <textarea 
          id="messageInput" 
          class="message-input" 
          placeholder="Write a sweet message for Beatrix..."
          maxlength="500"></textarea>
        <div class="message-buttons">
          <button class="message-btn save" onclick="saveMessage()">üíù Save Message</button>
          <button class="message-btn clear" onclick="clearMessage()">üóëÔ∏è Clear</button>
        </div>
      </div>
      <div id="messageDisplay" class="message-display">
        <strong>Your Message:</strong><br>
        <span id="messageText"></span>
        <br>
        <button class="edit-message-btn" onclick="editMessage()">‚úèÔ∏è Edit Message</button>
      </div>
    </div>

    <div class="temp-toggle">
      <button id="tempC" class="active" onclick="setTempUnit('C')">¬∞C</button>
      <button id="tempF" onclick="setTempUnit('F')">¬∞F</button>
    </div>

    <button class="music-toggle" id="musicBtn" onclick="toggleMusic()">üîá Music: OFF</button>
  </div>

  <audio id="bgMusic" loop>
    <source src="1.mp3" type="audio/mpeg">
  </audio>

  <script>
    // Temperature unit preference
    let tempUnit = 'C'; // Default to Celsius
    let weatherData = {
      ny: { temp_c: null, temp_f: null, weather_code: null, is_day: null },
      lon: { temp_c: null, temp_f: null, weather_code: null, is_day: null }
    };

    // Flight details
    const departure = new Date('2026-03-04T10:15:00-05:00');
    const arrival = new Date('2026-03-04T22:10:00+00:00');
    const countdownStart = new Date('2026-01-28T18:50:00+00:00');

    // JFK and LHR coordinates
    const JFK = { lat: 40.6413, lng: -73.7781 };
    const LHR = { lat: 51.4700, lng: -0.4543 };

    let map = null;
    let flightPath = null;
    let planeMarker = null;

    function initMap() {
      map = L.map('flightMap').setView([50, -30], 3);
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
      }).addTo(map);

      // Add markers for JFK and LHR
      L.marker([JFK.lat, JFK.lng]).addTo(map)
        .bindPopup('üá∫üá∏ JFK Airport, New York');
      
      L.marker([LHR.lat, LHR.lng]).addTo(map)
        .bindPopup('üá¨üáß Heathrow Airport, London');

      // Draw flight path
      flightPath = L.polyline([
        [JFK.lat, JFK.lng],
        [LHR.lat, LHR.lng]
      ], {
        color: '#e75480',
        weight: 3,
        opacity: 0.7,
        dashArray: '10, 10'
      }).addTo(map);

      // Create plane icon
      const planeIcon = L.divIcon({
        html: '‚úàÔ∏è',
        className: 'plane-marker',
        iconSize: [30, 30]
      });

      planeMarker = L.marker([JFK.lat, JFK.lng], { icon: planeIcon }).addTo(map);
      
      // Fix map display on mobile
      setTimeout(() => {
        map.invalidateSize();
      }, 100);
    }

    function updateFlightPosition() {
      const now = new Date();
      
      if (now >= departure && now <= arrival) {
        // Show map during flight
        document.getElementById('flightMapContainer').classList.add('active');
        
        if (!map) {
          initMap();
        }

        // Calculate flight progress (0 to 1)
        const flightDuration = arrival - departure;
        const flightElapsed = now - departure;
        const progress = flightElapsed / flightDuration;

        // Interpolate position between JFK and LHR
        const lat = JFK.lat + (LHR.lat - JFK.lat) * progress;
        const lng = JFK.lng + (LHR.lng - LHR.lng) * progress;

        // Update plane position
        if (planeMarker) {
          planeMarker.setLatLng([lat, lng]);
          map.setView([lat, lng], 4);
        }

        // Simulate altitude and speed (in reality you'd get this from API)
        const cruisingAltitude = 39000;
        const cruisingSpeed = 550;
        
        // Altitude increases/decreases at start/end
        let altitude;
        if (progress < 0.15) {
          altitude = Math.round(cruisingAltitude * (progress / 0.15));
        } else if (progress > 0.85) {
          altitude = Math.round(cruisingAltitude * ((1 - progress) / 0.15));
        } else {
          altitude = cruisingAltitude;
        }

        document.getElementById('altitude').textContent = altitude.toLocaleString() + ' ft';
        document.getElementById('speed').textContent = cruisingSpeed + ' mph';
        
        // Estimate location based on progress
        let location;
        if (progress < 0.1) location = "Departing New York";
        else if (progress < 0.3) location = "Over the Atlantic Ocean";
        else if (progress < 0.5) location = "Mid-Atlantic";
        else if (progress < 0.7) location = "Approaching Europe";
        else if (progress < 0.9) location = "Over Ireland/UK";
        else location = "Approaching London";
        
        document.getElementById('currentLocation').textContent = location;

      } else {
        // Hide map when not in flight
        document.getElementById('flightMapContainer').classList.remove('active');
      }
    }

    function updateCountdown() {
      const now = new Date();
      let timeLeft;

      if (now < departure) {
        timeLeft = departure - now;
        document.getElementById('status').textContent = '‚úàÔ∏è Until takeoff from JFK Terminal 8';
      } else if (now < arrival) {
        timeLeft = arrival - now;
        document.getElementById('status').textContent = '‚úàÔ∏è She is in the air right now!';
      } else {
        timeLeft = 0;
        document.getElementById('status').textContent = 'üéâ She has arrived in London!';
      }

      const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
      const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

      document.getElementById('days').textContent = days;
      document.getElementById('hours').textContent = String(hours).padStart(2, '0');
      document.getElementById('minutes').textContent = String(minutes).padStart(2, '0');
      document.getElementById('seconds').textContent = String(seconds).padStart(2, '0');

      const timeBoxes = document.querySelectorAll('.time-box');
      const totalHoursLeft = days * 24 + hours;
      
      if (totalHoursLeft < 24 && timeLeft > 0) {
        timeBoxes.forEach(box => box.classList.add('urgent'));
      } else {
        timeBoxes.forEach(box => box.classList.remove('urgent'));
      }

      const totalWaitTime = departure - countdownStart;
      const timeElapsed = now - countdownStart;
      let percentComplete = 0;
      
      if (now >= arrival) {
        percentComplete = 100;
        document.getElementById('flightProgress').style.display = 'none';
      } else if (now >= departure) {
        const flightDuration = arrival - departure;
        const flightElapsed = now - departure;
        percentComplete = 90 + (flightElapsed / flightDuration) * 10;
        
        const flightProgressDiv = document.getElementById('flightProgress');
        flightProgressDiv.style.display = 'block';
        
        const flightPercent = (flightElapsed / flightDuration) * 100;
        document.getElementById('flightProgressFill').style.width = flightPercent + '%';
        document.querySelector('.flight-progress-plane').style.left = `calc(${flightPercent}% - 12px)`;
        document.getElementById('flightProgressPercent').textContent = Math.round(flightPercent) + '%';
        
        const hoursLeft = Math.floor((arrival - now) / (1000 * 60 * 60));
        const minutesLeft = Math.floor(((arrival - now) % (1000 * 60 * 60)) / (1000 * 60));
        document.getElementById('flightTimeRemaining').textContent = `${hoursLeft}h ${minutesLeft}m remaining`;
      } else if (now >= countdownStart) {
        percentComplete = (timeElapsed / totalWaitTime) * 90;
        document.getElementById('flightProgress').style.display = 'none';
      }
      
      percentComplete = Math.max(0, Math.min(100, percentComplete));
      
      document.getElementById('percentFill').style.width = percentComplete + '%';
      
      if (percentComplete >= 100) {
        document.getElementById('percentText').textContent = 'üéâ 100% complete - The wait is over!';
      } else if (percentComplete >= 90) {
        document.getElementById('percentText').textContent = Math.round(percentComplete) + '% complete - Almost there!';
      } else {
        document.getElementById('percentText').textContent = Math.round(percentComplete) + '% of the wait complete';
      }

      updateTimes();
      updateFlightPosition();
    }

    function updateTimes() {
      const now = new Date();
      
      const nyTime = now.toLocaleTimeString('en-US', {
        timeZone: 'America/New_York',
        hour: '2-digit',
        minute: '2-digit',
        hour12: true
      });
      document.getElementById('nyTime').textContent = nyTime;

      const lonTime = now.toLocaleTimeString('en-US', {
        timeZone: 'Europe/London',
        hour: '2-digit',
        minute: '2-digit',
        hour12: true
      });
      document.getElementById('lonTime').textContent = lonTime;
    }

    function getWeatherIcon(weatherCode, isDay) {
      const weatherIcons = {
        0: isDay ? '‚òÄÔ∏è' : 'üåô',
        1: isDay ? 'üå§Ô∏è' : 'üåô',
        2: '‚õÖ',
        3: '‚òÅÔ∏è',
        45: 'üå´Ô∏è',
        48: 'üå´Ô∏è',
        51: 'üå¶Ô∏è',
        53: 'üå¶Ô∏è',
        55: 'üåßÔ∏è',
        61: 'üåßÔ∏è',
        63: 'üåßÔ∏è',
        65: '‚õàÔ∏è',
        71: 'üå®Ô∏è',
        73: 'üå®Ô∏è',
        75: '‚ùÑÔ∏è',
        77: 'üå®Ô∏è',
        80: 'üå¶Ô∏è',
        81: 'üåßÔ∏è',
        82: '‚õàÔ∏è',
        85: 'üå®Ô∏è',
        86: '‚ùÑÔ∏è',
        95: '‚õàÔ∏è',
        96: '‚õàÔ∏è',
        99: '‚õàÔ∏è'
      };
      return weatherIcons[weatherCode] || 'üå§Ô∏è';
    }

    async function fetchWeather() {
      try {
        const nyResponse = await fetch('https://api.open-meteo.com/v1/forecast?latitude=40.6413&longitude=-73.7781&current=temperature_2m,weather_code,is_day&temperature_unit=fahrenheit&timezone=America/New_York');
        const nyData = await nyResponse.json();
        
        if (nyData.current) {
          weatherData.ny.temp_f = Math.round(nyData.current.temperature_2m);
          weatherData.ny.temp_c = Math.round((nyData.current.temperature_2m - 32) * 5/9);
          weatherData.ny.weather_code = nyData.current.weather_code;
          weatherData.ny.is_day = nyData.current.is_day;
        }

        const lonResponse = await fetch('https://api.open-meteo.com/v1/forecast?latitude=51.4700&longitude=-0.4543&current=temperature_2m,weather_code,is_day&temperature_unit=celsius&timezone=Europe/London');
        const lonData = await lonResponse.json();
        
        if (lonData.current) {
          weatherData.lon.temp_c = Math.round(lonData.current.temperature_2m);
          weatherData.lon.temp_f = Math.round(lonData.current.temperature_2m * 9/5 + 32);
          weatherData.lon.weather_code = lonData.current.weather_code;
          weatherData.lon.is_day = lonData.current.is_day;
        }

        updateWeatherDisplay();
      } catch (error) {
        console.error('Weather fetch error:', error);
      }
    }

    function updateWeatherDisplay() {
      if (weatherData.ny.temp_c !== null) {
        const nyTemp = tempUnit === 'C' ? weatherData.ny.temp_c : weatherData.ny.temp_f;
        document.getElementById('nyTemp').textContent = nyTemp + '¬∞' + tempUnit;
        document.getElementById('nyWeatherIcon').textContent = getWeatherIcon(weatherData.ny.weather_code, weatherData.ny.is_day);
      }

      if (weatherData.lon.temp_c !== null) {
        const lonTemp = tempUnit === 'C' ? weatherData.lon.temp_c : weatherData.lon.temp_f;
        document.getElementById('lonTemp').textContent = lonTemp + '¬∞' + tempUnit;
        document.getElementById('lonWeatherIcon').textContent = getWeatherIcon(weatherData.lon.weather_code, weatherData.lon.is_day);
      }
    }

    function setTempUnit(unit) {
      tempUnit = unit;
      
      // Update button states
      document.getElementById('tempC').classList.toggle('active', unit === 'C');
      document.getElementById('tempF').classList.toggle('active', unit === 'F');
      
      // Update display
      updateWeatherDisplay();
    }

    fetchWeather();
    setInterval(fetchWeather, 600000);

    updateCountdown();
    setInterval(updateCountdown, 1000);

    // Particle effects
    const canvas = document.getElementById('particles');
    const ctx = canvas.getContext('2d');
    
    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    
    resizeCanvas();

    const particles = [];
    const particleCount = window.innerWidth < 480 ? 15 : 30; // Fewer particles on mobile

    class Particle {
      constructor() {
        this.reset();
        this.y = Math.random() * canvas.height;
        this.fadeDelay = Math.random() * 600;
        this.fadeStart = Date.now() + this.fadeDelay;
        this.symbol = Math.random() > 0.5 ? '‚ô•' : '‚ú®';
      }

      reset() {
        this.x = Math.random() * canvas.width;
        this.y = canvas.height + 10;
        this.speed = 0.3 + Math.random() * 0.5;
        this.opacity = 0;
        this.size = 10 + Math.random() * 10;
        this.drift = Math.random() * 0.5 - 0.25;
        this.symbol = Math.random() > 0.5 ? '‚ô•' : '‚ú®';
        this.fadeDelay = Math.random() * 600;
        this.fadeStart = Date.now() + this.fadeDelay;
      }

      update() {
        this.y -= this.speed;
        this.x += this.drift;

        if (Date.now() > this.fadeStart) {
          if (this.opacity < 0.6) {
            this.opacity += 0.005;
          }
        }

        if (this.y < -20) {
          this.reset();
        }
      }

      draw() {
        ctx.save();
        ctx.globalAlpha = this.opacity;
        ctx.font = `${this.size}px Arial`;
        ctx.fillStyle = this.symbol === '‚ô•' ? '#e75480' : '#ffb3c1';
        ctx.fillText(this.symbol, this.x, this.y);
        ctx.restore();
      }
    }

    for (let i = 0; i < particleCount; i++) {
      particles.push(new Particle());
    }

    function animateParticles() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      particles.forEach(particle => {
        particle.update();
        particle.draw();
      });

      requestAnimationFrame(animateParticles);
    }

    animateParticles();

    window.addEventListener('resize', () => {
      resizeCanvas();
    });

    // Message functions
    function saveMessage() {
      const messageInput = document.getElementById('messageInput');
      const message = messageInput.value.trim();
      
      if (message) {
        localStorage.setItem('beatrixMessage', message);
        document.getElementById('messageText').textContent = message;
        document.getElementById('messageInputSection').style.display = 'none';
        document.getElementById('messageDisplay').classList.add('active');
      }
    }

    function clearMessage() {
      document.getElementById('messageInput').value = '';
    }

    function editMessage() {
      document.getElementById('messageInputSection').style.display = 'block';
      document.getElementById('messageDisplay').classList.remove('active');
      const savedMessage = localStorage.getItem('beatrixMessage');
      if (savedMessage) {
        document.getElementById('messageInput').value = savedMessage;
      }
    }

    // Load saved message on page load
    window.addEventListener('DOMContentLoaded', () => {
      const savedMessage = localStorage.getItem('beatrixMessage');
      if (savedMessage) {
        document.getElementById('messageText').textContent = savedMessage;
        document.getElementById('messageInputSection').style.display = 'none';
        document.getElementById('messageDisplay').classList.add('active');
      }
    });

    // Music control
    let musicPlaying = false;
    const bgMusic = document.getElementById('bgMusic');
    const musicBtn = document.getElementById('musicBtn');

    // Don't autoplay on mobile - wait for user interaction
    bgMusic.volume = 0.3;

    function toggleMusic() {
      musicPlaying = !musicPlaying;
      
      if (musicPlaying) {
        bgMusic.volume = 0.3;
        bgMusic.play().then(() => {
          musicBtn.textContent = 'üîä Music: ON';
          musicBtn.classList.add('active');
        }).catch(err => {
          console.log('Music playback failed:', err);
          musicPlaying = false;
          musicBtn.textContent = 'üîá Music: OFF';
          musicBtn.classList.remove('active');
        });
      } else {
        bgMusic.pause();
        musicBtn.textContent = 'üîá Music: OFF';
        musicBtn.classList.remove('active');
      }
    }
  </script>
</body>
</html>